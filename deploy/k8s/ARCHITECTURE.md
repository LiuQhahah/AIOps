# OpsAgent Kubernetes 架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Kubernetes 集群                               │
│                                                                     │
│  ┌────────────────── Namespace: ops-system ────────────────────┐   │
│  │                                                              │   │
│  │  ┌──────────────────────────────────────────────────────┐   │   │
│  │  │         Deployment: opsagent (replicas: 1)           │   │   │
│  │  │                                                      │   │   │
│  │  │  ┌────────────────────────────────────────────────┐ │   │   │
│  │  │  │  Pod: opsagent-xxxxx                           │ │   │   │
│  │  │  │                                                │ │   │   │
│  │  │  │  ┌──────────────────────────────────────────┐ │ │   │   │
│  │  │  │  │  Container: opsagent                     │ │ │   │   │
│  │  │  │  │  Image: opsagent:latest                  │ │ │   │   │
│  │  │  │  │  User: opsagent (UID 1000)               │ │ │   │   │
│  │  │  │  │                                          │ │ │   │   │
│  │  │  │  │  Ports:                                  │ │ │   │   │
│  │  │  │  │  - 18080: API Server                     │ │ │   │   │
│  │  │  │  │  - 9090: Prometheus Metrics              │ │ │   │   │
│  │  │  │  │                                          │ │ │   │   │
│  │  │  │  │  Volumes:                                │ │ │   │   │
│  │  │  │  │  - /app/config (ConfigMap)               │ │ │   │   │
│  │  │  │  │  - /tmp (emptyDir)                       │ │ │   │   │
│  │  │  │  │  - /app/.cache (emptyDir)                │ │ │   │   │
│  │  │  │  │                                          │ │ │   │   │
│  │  │  │  │  Resources:                              │ │ │   │   │
│  │  │  │  │  - requests: 200m CPU, 256Mi Memory      │ │ │   │   │
│  │  │  │  │  - limits: 1000m CPU, 512Mi Memory       │ │ │   │   │
│  │  │  │  │                                          │ │ │   │   │
│  │  │  │  │  Probes:                                 │ │ │   │   │
│  │  │  │  │  - Liveness: GET /health (30s)           │ │ │   │   │
│  │  │  │  │  - Readiness: GET /health (10s)          │ │ │   │   │
│  │  │  │  └──────────────────────────────────────────┘ │ │   │   │
│  │  │  │                                                │ │   │   │
│  │  │  │  ServiceAccount: opsagent                      │ │   │   │
│  │  │  └────────────────────────────────────────────────┘ │   │   │
│  │  └──────────────────────────────────────────────────────┘   │   │
│  │                                                              │   │
│  │  ┌──────────────────────────────────────────────────────┐   │   │
│  │  │  Service: opsagent (ClusterIP)                       │   │   │
│  │  │  - Port 80 → 18080 (http)                            │   │   │
│  │  │  - Port 9090 → 9090 (metrics)                        │   │   │
│  │  │  Selector: app=opsagent                              │   │   │
│  │  └──────────────────────────────────────────────────────┘   │   │
│  │                                                              │   │
│  │  ┌──────────────────────────────────────────────────────┐   │   │
│  │  │  ConfigMap: opsagent-config                          │   │   │
│  │  │  - config.yaml: 应用配置                              │   │   │
│  │  └──────────────────────────────────────────────────────┘   │   │
│  │                                                              │   │
│  │  ┌──────────────────────────────────────────────────────┐   │   │
│  │  │  Secret: opsagent-secrets (可选)                      │   │   │
│  │  │  - AWS credentials                                    │   │   │
│  │  │  - Azure credentials                                  │   │   │
│  │  │  - GitHub token                                       │   │   │
│  │  └──────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────── Cluster-Level RBAC ────────────────────┐     │
│  │                                                            │     │
│  │  ServiceAccount: ops-system/opsagent                       │     │
│  │         ↓                                                  │     │
│  │  ClusterRoleBinding: opsagent-reader-binding               │     │
│  │         ↓                                                  │     │
│  │  ClusterRole: opsagent-reader                              │     │
│  │                                                            │     │
│  │  权限 (只读):                                               │     │
│  │  ✓ apps: deployments, statefulsets, daemonsets            │     │
│  │  ✓ core: pods, services, configmaps, namespaces, nodes    │     │
│  │  ✓ metrics.k8s.io: pods, nodes                            │     │
│  │  ✗ 无任何写入权限                                           │     │
│  └────────────────────────────────────────────────────────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 工作流程

```
┌──────────────────── OpsAgent 运行流程 ────────────────────┐
│                                                           │
│  1. 启动阶段                                               │
│  ┌───────────────────────────────────────────────────┐   │
│  │ Pod 启动                                           │   │
│  │   ↓                                                │   │
│  │ 加载 in-cluster K8s config                         │   │
│  │   ↓                                                │   │
│  │ 初始化检测引擎                                       │   │
│  │   ↓                                                │   │
│  │ 启动 API Server (18080)                            │   │
│  │   ↓                                                │   │
│  │ 启动检测调度器 (APScheduler)                         │   │
│  │   ↓                                                │   │
│  │ 就绪，等待第一个检测周期                              │   │
│  └───────────────────────────────────────────────────┘   │
│                                                           │
│  2. 检测周期 (每 5 分钟)                                   │
│  ┌───────────────────────────────────────────────────┐   │
│  │ 调度器触发检测                                       │   │
│  │   ↓                                                │   │
│  │ 调用 PodResourceDetector.detect()                  │   │
│  │   ↓                                                │   │
│  │ 使用 K8s API 列出所有:                              │   │
│  │   - Deployments                                    │   │
│  │   - StatefulSets                                   │   │
│  │   - DaemonSets                                     │   │
│  │   ↓                                                │   │
│  │ 对每个资源:                                         │   │
│  │   - 跳过系统命名空间                                 │   │
│  │   - 检查每个容器                                     │   │
│  │   - 检测缺少资源限制                                 │   │
│  │   - 检测资源过度配置                                 │   │
│  │   ↓                                                │   │
│  │ 生成 Issue 列表                                     │   │
│  │   ↓                                                │   │
│  │ 记录检测结果到日志                                   │   │
│  │   ↓                                                │   │
│  │ 更新 Prometheus 指标                                │   │
│  │   ↓                                                │   │
│  │ 等待下一个周期                                       │   │
│  └───────────────────────────────────────────────────┘   │
│                                                           │
│  3. API 请求处理                                          │
│  ┌───────────────────────────────────────────────────┐   │
│  │ 接收 HTTP 请求 (18080)                             │   │
│  │   ↓                                                │   │
│  │ FastAPI 路由                                       │   │
│  │   ↓                                                │   │
│  │ 处理请求 (健康检查, 获取问题列表等)                   │   │
│  │   ↓                                                │   │
│  │ 返回 JSON 响应                                      │   │
│  └───────────────────────────────────────────────────┘   │
│                                                           │
│  4. Metrics 暴露                                          │
│  ┌───────────────────────────────────────────────────┐   │
│  │ Prometheus 抓取 /metrics (9090)                    │   │
│  │   ↓                                                │   │
│  │ 返回指标:                                           │   │
│  │   - opsagent_detection_runs_total                  │   │
│  │   - opsagent_issues_found_total                    │   │
│  │   - opsagent_detection_duration_seconds            │   │
│  │   - opsagent_issues_by_severity                    │   │
│  └───────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
```

## 网络拓扑

```
┌────────────────────────────────────────────────────────────┐
│                      Kubernetes 网络                        │
│                                                            │
│  ┌──────────── Cluster 内部通信 ──────────────┐            │
│  │                                            │            │
│  │  Pod (opsagent)                            │            │
│  │    ↓ (ServiceAccount Token)                │            │
│  │  Kubernetes API Server                     │            │
│  │    - 列出 Deployments                       │            │
│  │    - 列出 StatefulSets                      │            │
│  │    - 列出 DaemonSets                        │            │
│  │    - 列出 Pods                              │            │
│  │    - 列出 Nodes                             │            │
│  │    ↓ (只读权限)                             │            │
│  │  返回资源列表                                │            │
│  └────────────────────────────────────────────┘            │
│                                                            │
│  ┌──────────── Service 访问 ──────────────────┐            │
│  │                                            │            │
│  │  Pod in same cluster                       │            │
│  │    ↓ (HTTP)                                │            │
│  │  Service: opsagent.ops-system.svc          │            │
│  │    - Port 80 → Pod:18080                   │            │
│  │    - Port 9090 → Pod:9090                  │            │
│  │    ↓                                       │            │
│  │  OpsAgent Pod                              │            │
│  └────────────────────────────────────────────┘            │
│                                                            │
│  ┌──────────── 外部访问 (可选) ─────────────────┐           │
│  │                                            │            │
│  │  kubectl port-forward                      │            │
│  │    ↓                                       │            │
│  │  localhost:18080 → Pod:18080               │            │
│  │                                            │            │
│  │  或                                        │            │
│  │                                            │            │
│  │  Ingress Controller                        │            │
│  │    ↓                                       │            │
│  │  Service: opsagent                         │            │
│  │    ↓                                       │            │
│  │  OpsAgent Pod                              │            │
│  └────────────────────────────────────────────┘            │
└────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌───────────── 检测数据流 ─────────────┐
│                                     │
│  Kubernetes API                     │
│    ↓ (读取资源)                      │
│  OpsAgent Pod                       │
│    ↓ (分析配置)                      │
│  Issue 对象                         │
│    ↓ (生成报告)                      │
│  [日志输出]                          │
│    ↓                                │
│  stdout → Kubernetes 日志系统        │
│    ↓                                │
│  可选: 日志收集器 (Fluentd/Loki)     │
│                                     │
│  [Metrics 输出]                      │
│    ↓                                │
│  Prometheus endpoint (:9090/metrics)│
│    ↓                                │
│  Prometheus Server                  │
│    ↓                                │
│  Grafana Dashboard                  │
└─────────────────────────────────────┘
```

## 安全边界

```
┌────────────────── 安全控制 ──────────────────┐
│                                             │
│  1. 网络层                                   │
│  ┌──────────────────────────────────────┐   │
│  │ NetworkPolicy (可选)                  │   │
│  │ - 允许: Pod → K8s API                 │   │
│  │ - 允许: Prometheus → Pod:9090         │   │
│  │ - 拒绝: 其他所有入站流量               │   │
│  └──────────────────────────────────────┘   │
│                                             │
│  2. RBAC 层                                 │
│  ┌──────────────────────────────────────┐   │
│  │ ServiceAccount: opsagent              │   │
│  │   ↓                                   │   │
│  │ ClusterRole: opsagent-reader          │   │
│  │   - 只读权限                          │   │
│  │   - 无 create/update/delete           │   │
│  │   - 无 Secret 访问权限                │   │
│  └──────────────────────────────────────┘   │
│                                             │
│  3. Pod Security                            │
│  ┌──────────────────────────────────────┐   │
│  │ SecurityContext:                      │   │
│  │   - runAsNonRoot: true                │   │
│  │   - runAsUser: 1000                   │   │
│  │   - fsGroup: 1000                     │   │
│  │   - allowPrivilegeEscalation: false   │   │
│  │   - capabilities: drop ALL            │   │
│  └──────────────────────────────────────┘   │
│                                             │
│  4. Secret 管理                             │
│  ┌──────────────────────────────────────┐   │
│  │ Kubernetes Secret                     │   │
│  │   - 加密存储 (at-rest encryption)     │   │
│  │   - 仅作为环境变量注入                │   │
│  │   - 不写入日志                        │   │
│  └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## 资源依赖关系

```
Namespace (ops-system)
  ├── ServiceAccount (opsagent)
  │     └── 被 Pod 使用
  │
  ├── ClusterRole (opsagent-reader)
  │     └── 定义权限
  │
  ├── ClusterRoleBinding (opsagent-reader-binding)
  │     ├── 引用 ServiceAccount
  │     └── 引用 ClusterRole
  │
  ├── ConfigMap (opsagent-config)
  │     └── 被 Pod 挂载
  │
  ├── Secret (opsagent-secrets) [可选]
  │     └── 被 Pod 作为环境变量使用
  │
  ├── Deployment (opsagent)
  │     ├── 使用 ServiceAccount
  │     ├── 挂载 ConfigMap
  │     ├── 引用 Secret (可选)
  │     └── 创建 Pod
  │
  └── Service (opsagent)
        └── 选择 Pod (selector: app=opsagent)
```

## 高可用性设计

```
┌──────────── 可用性保障 ────────────┐
│                                   │
│  Deployment (replicas: 1)         │
│    ↓                              │
│  Pod                              │
│    │                              │
│    ├─ Liveness Probe              │
│    │  - 每 30s 检查一次            │
│    │  - 失败 3 次重启 Pod          │
│    │                              │
│    ├─ Readiness Probe             │
│    │  - 每 10s 检查一次            │
│    │  - 失败则从 Service 移除      │
│    │                              │
│    └─ Resource Limits             │
│       - 防止资源耗尽              │
│       - OOM 自动重启              │
│                                   │
│  重启策略: Always                  │
│    ↓                              │
│  自动恢复                          │
└───────────────────────────────────┘

注意: 建议单实例运行，避免重复检测
```

## 扩展性考虑

```
┌────────────── 扩展策略 ──────────────┐
│                                     │
│  当前: 单实例 (推荐)                 │
│  - 避免重复检测                      │
│  - 简化状态管理                      │
│                                     │
│  未来: 多实例 (需要改造)             │
│  ┌────────────────────────────┐    │
│  │ 需要实现:                   │    │
│  │ 1. 分布式锁                 │    │
│  │ 2. 工作队列                 │    │
│  │ 3. 状态共享                 │    │
│  │ 4. 领导选举                 │    │
│  └────────────────────────────┘    │
│                                     │
│  水平扩展考虑:                       │
│  - 按命名空间分区                    │
│  - 按资源类型分区                    │
│  - 使用消息队列协调                  │
└─────────────────────────────────────┘
```

---

**架构版本**: 1.0.0
**最后更新**: 2024年
